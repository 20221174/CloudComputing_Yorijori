<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Combined Posts</title>
    <link rel="stylesheet" href="/css/recipe/styles.css">
    <link rel="stylesheet" href="/css/recipe/searchResult.css">
</head>
<body>
    <div class="posts-section">
        <h1>많이 본 게시글</h1> 
        <div id="container" class="view-posts-container">
            <div id="searchResult" class="view-posts">
                <% if (viewPosts.length > 0) { %>
                    <div class="list-group">
                        <% viewPosts.slice(0, 3).forEach(post => { %>
                            <div class="recipe-card">
                                <% if (post.images && post.images.length > 0) { %>
                                    <img src="<%= post.images[0].imageUrl %>" alt="postImage" class="recipe-image">
                                <% } %>
                                <h2><%= post.title %></h2>
                                <button
                                    class="bookmark-button <%= savedPostIds.includes(post.postId) ? 'bookmark-saved' : 'bookmark-not-saved' %>" 
                                    id="btn-<%= post.postId %>" 
                                    onclick="saveBookmark('<%= post.postId %>');">
                                </button>
                                <p>주재료: <%= post.ingredients %></p>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <p>No posts available for this category.</p>
                <% } %>
            </div>
        </div>
    </div>

    <div class="posts-section">
    <h1>추천 게시글</h1> 
        <div id="container" class="recommend-posts-container">
            <div id="searchResult" class="recommend-posts">
                <% if (recommendPosts.length > 0) { %>
                    <div class="list-group">
                        <% recommendPosts.slice(0, 9).forEach(post => { %>
                            <div class="recipe-card">
                                <% if (post.images && post.images.length > 0) { %>
                                    <img src="<%= post.images[0].imageUrl %>" alt="postImage" class="recipe-image">
                                <% } %>
                                <h2><%= post.title %></h2>
                                <p>주재료: <%= post.ingredients %></p>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <p>No posts available for this category.</p>
                <% } %>
            </div>
        </div>
    </div>

    <div id="side-bar">    
        <!-- 로그인하지 않은 사용자는 로그인 페이지로 이동-->
        <div class="goto-funding">
            <a href="/joinFundingPage/fundingPage">
            <img src="/assets/image.png" class="funding-icon">
            <p class="funding-txt">펀딩하러 가기</p>
            </a>
        </div>
    </div>
    
    <script>
        const userId = '<%= user ? user.userId : "" %>';

        function saveBookmark(postId) {
            if (!userId) {
                alert('User is not logged in.');
                console.error('User is not logged in.');
                return;
            }

            const button = document.getElementById('btn-' + postId);
            const isSaved = button.classList.contains('bookmark-saved');
            const url = isSaved ? '/posts/unsave' : '/posts/save';
            const method = isSaved ? 'POST' : 'POST'; // 모두 POST 메서드 사용

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ userId, postId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isSaved) {
                        button.classList.remove('bookmark-saved');
                        button.classList.add('bookmark-not-saved');
                    } else {
                        button.classList.remove('bookmark-not-saved');
                        button.classList.add('bookmark-saved');
                    }
                } else {
                    alert('Failed to save the recipe.');
                }
            })
            .catch((error) => {
                alert(error);
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>